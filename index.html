<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Two Blog</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      color: #333;
    }
    header {
      background: #4a90e2;
      color: white;
      padding: 2rem;
      text-align: center;
    }
    .tabs {
      display: flex;
      list-style: none;
      padding: 0;
      margin: 0;
      background: #ddd;
    }
    .tabs li {
      padding: 1rem 2rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    .tabs li.active {
      background: white;
      border-bottom: 3px solid #4a90e2;
    }
    .tabs li:hover {
      background: #eee;
    }
    .tab-content > div {
      display: none;
      padding: 20px;
    }
    .tab-content > div.active {
      display: block;
    }
    .creator {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .creator img {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border: 2px solid #ccc;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Welcome to the Team Two Blog Website!</h1>
    <p>Let's chat about interesting stuff.</p>
  </header>

  <ul class="tabs">
    <li data-tab-target="#home" class="active tab">Home</li>
    <li data-tab-target="#hobbies" class="tab">Hobbies</li>
    <li data-tab-target="#recommendations" class="tab">Recommendations</li>
    <li data-tab-target="#music" class="tab">Music</li>
    <li data-tab-target="#about" class="tab">About</li>
  </ul>
  
  <div class="tab-content">
    
    <!-- HOME PAGE -->
    <div id="home" data-tab-content class="active">
      <h1 style="text-align: center;">Posts</h1>
      <p style="text-align: center;">Welcome to our homepage! Check out the other tabs to share your hobbies, recommendations, and music picks.</p>
    </div>

    <!-- HOBBIES TAB -->
    <div id="hobbies" data-tab-content>
      <h1 style="text-align:center;">Share Your Favorite Hobbies</h1>
      <div style="display: flex; gap: 40px; align-items: flex-start; justify-content: space-between; flex-wrap: wrap;">
        <div style="flex: 1 1 60%; min-width: 300px;">
          <div style="border: 2px solid #ccc; border-radius: 10px; padding: 20px;">
            <div id="postsContainer"></div>
          </div>
        </div>
        <div style="flex: 1 1 35%; min-width: 250px;">
          <input type="text" id="postEmail" placeholder="Email address (optional)" style="width: 100%; padding: 10px; margin-top: 10px;"><br>
          <input type="text" id="postTitle" placeholder="Post Title" style="width: 100%; padding: 10px; margin-top: 10px;"><br>
          <textarea id="postContent" placeholder="Write about your hobby..." rows="5" style="width: 100%; padding: 10px; margin-top: 10px;"></textarea><br>
          <input type="file" id="postImage" accept="image/*" style="margin-top: 10px;"><br>
          <button id="addPostBtn" style="margin-top: 10px; padding: 10px 20px; width: 100%;">Add Post</button>
        </div>
      </div>
    </div>

    <!-- RECOMMENDATIONS TAB -->
    <div id="recommendations" data-tab-content>
      <h1 style="text-align:center;">Share Your Recommendations</h1>
      <div style="display: flex; gap: 40px; align-items: flex-start; justify-content: space-between; flex-wrap: wrap;">
        <div style="flex: 1 1 60%; min-width: 300px;">
          <div style="border: 2px solid #ccc; border-radius: 10px; padding: 20px;">
            <div id="recommendationPostsContainer"></div>
          </div>
        </div>
        <div style="flex: 1 1 35%; min-width: 250px;">
          <input type="text" id="recEmail" placeholder="Email address (optional)" style="width: 100%; padding: 10px; margin-top: 10px;"><br>
          <input type="text" id="recTitle" placeholder="Recommendation Title" style="width: 100%; padding: 10px; margin-top: 10px;"><br>
          <textarea id="recContent" placeholder="Write your recommendation..." rows="5" style="width: 100%; padding: 10px; margin-top: 10px;"></textarea><br>
          <input type="file" id="recImage" accept="image/*" style="margin-top: 10px;"><br>
          <button id="addRecBtn" style="margin-top: 10px; padding: 10px 20px; width: 100%;">Add Recommendation</button>
        </div>
      </div>
    </div>

    <!-- MUSIC TAB -->
    <div id="music" data-tab-content>
      <h1 style="text-align:center;">Share Your Music Picks</h1>
      <div style="display: flex; gap: 40px; align-items: flex-start; justify-content: space-between; flex-wrap: wrap;">
        <div style="flex: 1 1 60%; min-width: 300px;">
          <div style="border: 2px solid #ccc; border-radius: 10px; padding: 20px;">
            <div id="musicPostsContainer"></div>
          </div>
        </div>
        <div style="flex: 1 1 35%; min-width: 250px;">
          <input type="text" id="musicEmail" placeholder="Email address (optional)" style="width: 100%; padding: 10px; margin-top: 10px;"><br>
          <input type="text" id="musicTitle" placeholder="Track or Album Title" style="width: 100%; padding: 10px; margin-top: 10px;"><br>
          <textarea id="musicContent" placeholder="Why do you love it?" rows="5" style="width: 100%; padding: 10px; margin-top: 10px;"></textarea><br>
          <input type="file" id="musicImage" accept="image/*" style="margin-top: 10px;"><br>
          <button id="addMusicBtn" style="margin-top: 10px; padding: 10px 20px; width: 100%;">Add Music Post</button>
        </div>
      </div>
    </div>

    <!-- ABOUT PAGE -->
    <div id="about" data-tab-content>
      <h1 style="text-align: center;">Meet the Creators</h1>
      <h2 style="text-align: center;">Welcome, covert channel fans!</h2>
      
      <h2>About the creators</h2>
      <div class="creator">
        <div style="width: 150px; height: 150px; background: #ddd; border: 2px solid #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center;">Cambria</div>
        <div>
          <p><strong>Cambria</strong> is in her last semester at RIT, graduating with a double major in Cybersecurity and Public Policy.</p>
        </div>
      </div>
      
      <div class="creator">
        <div style="width: 150px; height: 150px; background: #ddd; border: 2px solid #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center;">Gweneth</div>
        <div>
          <p><strong>Gweneth</strong> is in her last year at RIT graduating with a Bachelor's Degree in Cybersecurity.</p>
        </div>
      </div>
      
      <div class="creator">
        <div style="width: 150px; height: 150px; background: #ddd; border: 2px solid #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center;">Jack</div>
        <div>
          <p><strong>Jack</strong> is ....</p>
        </div>
      </div>
    </div>

  </div>

<script>
// GLOBAL SUPABASE INITIALIZATION
const SUPABASE_URL = 'https://ctntcjgybbhbirfhnsjs.supabase.co'; 
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0bnRjamd5YmJoYmlyZmhuc2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc0MTcwMjUsImV4cCI6MjA1Mjk5MzAyNX0.gxaXmf7Qm0a2zYP5Hqv3lB8jT6kRwNmC4oD9eUfI1sA'; 

let supabase = null;

// Initialize Supabase
if (window.supabase && typeof window.supabase.createClient === 'function') {
  const { createClient } = window.supabase;
  supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  console.log('✅ Supabase initialized');
  window.supabaseClient = supabase; // Make globally accessible
} else {
  console.error('❌ Supabase client not available');
}

// HELPER FUNCTIONS FOR PYTHON SCRIPTS
window.getPostsByCategory = async function(category) {
  if (!supabase) return [];
  const { data, error } = await supabase
    .from('posts')
    .select('*')
    .eq('category', category)
    .order('created_at', { ascending: false });
  if (error) {
    console.error('Error fetching posts:', error);
    return [];
  }
  return data || [];
};

window.getLatestPost = async function(category) {
  const posts = await window.getPostsByCategory(category);
  return posts.length > 0 ? posts[0] : null;
};

window.extractShift = function(content) {
  if (!content) return 0;
  return content.length - content.trimEnd().length;
};

// Image compression utility
function compressImage(file, maxWidth = 800, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        let width = img.width;
        let height = img.height;
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Tab switching
document.addEventListener('DOMContentLoaded', () => {
  const tabs = document.querySelectorAll('[data-tab-target]');
  const tabContents = document.querySelectorAll('[data-tab-content]');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const target = document.querySelector(tab.dataset.tabTarget);
      if (!target) return;
      tabContents.forEach(tc => tc.classList.remove('active'));
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      target.classList.add('active');
    });
  });

  // Wire up buttons
  document.getElementById('addPostBtn').addEventListener('click', addPost);
  document.getElementById('addRecBtn').addEventListener('click', addRecommendationPost);
  document.getElementById('addMusicBtn').addEventListener('click', addMusicPost);

  // Load posts
  loadPostsByCategory('hobby', 'postsContainer');
  loadPostsByCategory('recommendation', 'recommendationPostsContainer');
  loadPostsByCategory('music', 'musicPostsContainer');
});

// Load posts from database
async function loadPostsByCategory(category, containerId) {
  const container = document.getElementById(containerId);
  if (!container || !supabase) return;
  
  container.innerHTML = '<p>Loading...</p>';
  const posts = await window.getPostsByCategory(category);
  container.innerHTML = '';
  
  if (posts.length === 0) {
    container.innerHTML = '<p>No posts yet.</p>';
    return;
  }
  
  posts.forEach(post => renderPostRow(post, container));
}

// Render post
function renderPostRow(post, container) {
  const postSection = document.createElement('section');
  postSection.style.borderBottom = '1px solid #ccc';
  postSection.style.padding = '10px 0';
  postSection.style.overflow = 'hidden';
  postSection.style.marginBottom = '15px';

  if (post.image_url) {
    const img = document.createElement('img');
    img.src = post.image_url;
    img.alt = "Post image";
    img.style.float = "right";
    img.style.marginLeft = "20px";
    img.style.marginBottom = "10px";
    img.style.width = "200px";
    img.style.height = "auto";
    img.style.borderRadius = "8px";
    img.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
    postSection.appendChild(img);
  }

  const postTitle = document.createElement('h2');
  postTitle.textContent = post.title;

  const postText = document.createElement('p');
  postText.textContent = post.content;

  const postTime = document.createElement('small');
  postTime.textContent = `Posted on ${new Date(post.created_at).toLocaleString()}`;
  postTime.style.display = 'block';
  postTime.style.marginTop = '5px';
  postTime.style.color = '#666';

  if (post.email) {
    const emailTag = document.createElement('small');
    emailTag.textContent = `Email: ${post.email}`;
    emailTag.style.display = 'block';
    emailTag.style.color = '#444';
    emailTag.style.marginBottom = '5px';
    postSection.appendChild(emailTag);
  }

  const deleteBtn = document.createElement('button');
  deleteBtn.textContent = 'Delete Post';
  deleteBtn.style.marginTop = '10px';
  deleteBtn.style.padding = '5px 10px';
  deleteBtn.onclick = async function () {
    if (!supabase || !post.id) return;
    const { error } = await supabase.from('posts').delete().eq('id', post.id);
    if (error) {
      alert('Could not delete post.');
      return;
    }
    postSection.remove();
  };

  postSection.appendChild(postTitle);
  postSection.appendChild(postText);
  postSection.appendChild(postTime);
  postSection.appendChild(deleteBtn);

  container.appendChild(postSection);
}

// ADD POST FUNCTIONS
async function addPost() {
  const title = document.getElementById('postTitle').value.trim();
  const content = document.getElementById('postContent').value.trim();
  const emailInput = document.getElementById('postEmail').value.trim();
  const imageInput = document.getElementById('postImage');
  const imageFile = imageInput ? imageInput.files[0] : null;

  if (!title || !content) {
    alert('Please enter both a title and content.');
    return;
  }

  const isNumeric = /^\d+$/.test(emailInput);
  const crmValue = isNumeric ? emailInput : null;
  const emailToDisplay = isNumeric ? null : emailInput;

  let imageUrl = null;
  if (imageFile) {
    try {
      imageUrl = await compressImage(imageFile);
    } catch (err) {
      alert("Error processing image.");
      return;
    }
  }

  if (!supabase) {
    alert('Database not connected');
    return;
  }

  const { error } = await supabase.from('posts').insert([{
    category: 'hobby',
    title,
    content,
    email: emailToDisplay,
    crm: crmValue,
    image_url: imageUrl
  }]);
  
  if (error) {
    console.error('Insert error:', error);
    alert('Failed to save post');
    return;
  }

  document.getElementById('postTitle').value = '';
  document.getElementById('postContent').value = '';
  document.getElementById('postEmail').value = '';
  document.getElementById('postImage').value = '';
  
  await loadPostsByCategory('hobby', 'postsContainer');
}

async function addRecommendationPost() {
  const title = document.getElementById('recTitle').value.trim();
  const content = document.getElementById('recContent').value.trim();
  const emailInput = document.getElementById('recEmail').value.trim();
  const imageInput = document.getElementById('recImage');
  const imageFile = imageInput ? imageInput.files[0] : null;

  if (!title || !content) {
    alert('Please enter both a title and content.');
    return;
  }

  const isNumeric = /^\d+$/.test(emailInput);
  const crmValue = isNumeric ? emailInput : null;
  const emailToDisplay = isNumeric ? null : emailInput;

  let imageUrl = null;
  if (imageFile) {
    try {
      imageUrl = await compressImage(imageFile);
    } catch (err) {
      alert("Error processing image.");
      return;
    }
  }

  if (!supabase) {
    alert('Database not connected');
    return;
  }

  const { error } = await supabase.from('posts').insert([{
    category: 'recommendation',
    title,
    content,
    email: emailToDisplay,
    crm: crmValue,
    image_url: imageUrl
  }]);
  
  if (error) {
    console.error('Insert error:', error);
    alert('Failed to save post');
    return;
  }

  document.getElementById('recTitle').value = '';
  document.getElementById('recContent').value = '';
  document.getElementById('recEmail').value = '';
  document.getElementById('recImage').value = '';
  
  await loadPostsByCategory('recommendation', 'recommendationPostsContainer');
}

async function addMusicPost() {
  const title = document.getElementById('musicTitle').value.trim();
  const content = document.getElementById('musicContent').value.trim();
  const emailInput = document.getElementById('musicEmail').value.trim();
  const imageInput = document.getElementById('musicImage');
  const imageFile = imageInput ? imageInput.files[0] : null;

  if (!title || !content) {
    alert('Please enter both a title and content.');
    return;
  }

  const isNumeric = /^\d+$/.test(emailInput);
  const crmValue = isNumeric ? emailInput : null;
  const emailToDisplay = isNumeric ? null : emailInput;

  let imageUrl = null;
  if (imageFile) {
    try {
      imageUrl = await compressImage(imageFile);
    } catch (err) {
      alert("Error processing image.");
      return;
    }
  }

  if (!supabase) {
    alert('Database not connected');
    return;
  }

  const { error } = await supabase.from('posts').insert([{
    category: 'music',
    title,
    content,
    email: emailToDisplay,
    crm: crmValue,
    image_url: imageUrl
  }]);
  
  if (error) {
    console.error('Insert error:', error);
    alert('Failed to save post');
    return;
  }

  document.getElementById('musicTitle').value = '';
  document.getElementById('musicContent').value = '';
  document.getElementById('musicEmail').value = '';
  document.getElementById('musicImage').value = '';
  
  await loadPostsByCategory('music', 'musicPostsContainer');
}
</script>

</body>
</html>
